<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Kicks</title>
  <link rel="stylesheet" href="/styles/index.css" />
  <style>
    /* Basic header styling for layout */
    header {
      position: relative;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    /* Container for header text */
    .header-content {
      /* you can style the header content as needed */
    }
    /* Style the cart button and position it at top-right */
    .cart-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1.2rem;
      cursor: pointer;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Secure Kicks</h1>
      <p>Simple. Secure. Sneakers.</p>
    </div>
    <button class="cart-btn" onclick="goToCart()">ðŸ›’ Cart</button>
  </header>

  <main class="product-grid" id="productGrid"></main>

  <script src="/scripts/shared.js"></script>
  <script>
    const productGrid = document.getElementById("productGrid");

    // Load products once the cart is fetched
    async function loadProducts() {
      const cart = await getCart();

      await loadInventory();
      
      inventory.forEach(product => {
        const quantityInCart = cart.find(item => item.id === product.id)?.quantity || 0;
        const card = document.createElement("div");
        card.className = "product-card";

        card.innerHTML = `
          <img src="${product.image}" alt="${product.name}">
          <h2>${product.name}</h2>
          <p>$${product.price.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>

          <div class="quantity-control">
            <button onclick="updateQuantity(${product.id}, -1)">âˆ’</button>
            <input type="number" id="qty-${product.id}" min="0" max="${product.stock}" value="${quantityInCart}" onchange="setQuantity(${product.id}, this.value)">
            <button onclick="updateQuantity(${product.id}, 1)">+</button>
          </div>

          <p id="stock-${product.id}" class="stock-label">${quantityInCart} / ${product.stock} in cart</p>
          <button class="view-btn" onclick="viewProduct(${product.id})">ðŸ‘Ÿ View Product</button>
        `;

        productGrid.appendChild(card);
      });
    }

    // Increase or decrease quantity and update the cart on the server
    function updateQuantity(productId, change) {
        console.log(`updateQuantity called with productId=${productId} change=${change}`);
        const input = document.getElementById(`qty-${productId}`);
        let qty = parseInt(input.value) + change;
        const product = getProductById(productId);
        qty = Math.max(0, Math.min(product.stock, qty));
        console.log(`New quantity: ${qty}`);

        input.value = qty;
        setCartQuantity(productId, qty);
        refreshStockLabel(productId, qty);
    }

    // Set the quantity directly and update the cart on the server
    function setQuantity(productId, value) {
      const qty = Math.max(0, Math.min(getProductById(productId).stock, parseInt(value)));
      setCartQuantity(productId, qty);
      refreshStockLabel(productId, qty);
    }

    // Refresh the displayed stock label for a product
    function refreshStockLabel(productId, qty) {
      const label = document.getElementById(`stock-${productId}`);
      if (label) {
        const product = getProductById(productId);
        label.textContent = `${qty} / ${product.stock} in cart`;
      }
    }

    // Navigate to the product details page
    function viewProduct(id) {
      window.location.href = `/sneaker/${id}`;
    }

    // Navigate to the cart page
    function goToCart() {
      window.location.href = "/cart";
    }

    // Initialize the page by loading products
    loadProducts();
  </script>
</body>
</html>
